// ═══════════════════════════════════════════════════════════════
// LAYER 4: Vulnerability & Threat Layer
// CVE → CWE → CAPEC → ATT&CK → Threat Actor (20+ hop correlations)
// Created: 2025-10-29
// ═══════════════════════════════════════════════════════════════

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: CVE (Common Vulnerabilities and Exposures)
// ───────────────────────────────────────────────────────────────
// Properties:
//   cveId: string (e.g., "CVE-2023-12345") - UNIQUE CONSTRAINT
//   description: string
//   publishedDate: date
//   lastModifiedDate: date
//   cvssV3Vector: string (e.g., "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H")
//   cvssV3BaseScore: float (0.0 - 10.0)
//   cvssV3Severity: enum [NONE, LOW, MEDIUM, HIGH, CRITICAL]
//   exploitabilityScore: float
//   impactScore: float
//   hasExploit: boolean
//   exploitMaturity: enum [UNPROVEN, POC, FUNCTIONAL, HIGH, NOT_DEFINED]
//   is_shared: boolean (always true - CVEs are global knowledge)
//   customer_namespace: "shared:nvd" (always shared)
// ───────────────────────────────────────────────────────────────

// Example: CVE-2022-22954 (VMware Workspace ONE Access RCE)
CREATE (cve:CVE {
  cveId: 'CVE-2022-22954',
  description: 'VMware Workspace ONE Access and Identity Manager contain a remote code execution vulnerability due to server-side template injection.',
  publishedDate: date('2022-04-06'),
  lastModifiedDate: date('2023-11-07'),
  cvssV3Vector: 'CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H',
  cvssV3BaseScore: 9.8,
  cvssV3Severity: 'CRITICAL',
  exploitabilityScore: 3.9,
  impactScore: 5.9,
  hasExploit: true,
  exploitMaturity: 'FUNCTIONAL',
  is_shared: true,
  customer_namespace: 'shared:nvd'
});

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: CWE (Common Weakness Enumeration)
// ───────────────────────────────────────────────────────────────
// Properties:
//   cweId: string (e.g., "CWE-79") - UNIQUE CONSTRAINT
//   name: string
//   description: string
//   abstraction: enum [PILLAR, CLASS, BASE, VARIANT, COMPOUND]
//   likelihood: enum [HIGH, MEDIUM, LOW]
//   is_shared: boolean (always true)
//   customer_namespace: "shared:cwe"
// ───────────────────────────────────────────────────────────────

CREATE (cwe:CWE {
  cweId: 'CWE-94',
  name: 'Improper Control of Generation of Code (Code Injection)',
  description: 'The software constructs all or part of a code segment using externally-influenced input from an upstream component, but it does not neutralize or incorrectly neutralizes special elements that could modify the syntax or behavior of the intended code segment.',
  abstraction: 'BASE',
  likelihood: 'HIGH',
  is_shared: true,
  customer_namespace: 'shared:cwe'
});

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: CAPEC (Common Attack Pattern Enumeration)
// ───────────────────────────────────────────────────────────────
// Properties:
//   capecId: string (e.g., "CAPEC-242") - UNIQUE CONSTRAINT
//   name: string
//   description: string
//   abstraction: enum [META, STANDARD, DETAILED]
//   likelihood: enum [HIGH, MEDIUM, LOW]
//   severity: enum [VERY_HIGH, HIGH, MEDIUM, LOW, VERY_LOW]
//   prerequisites: string[]
//   is_shared: boolean (always true)
//   customer_namespace: "shared:capec"
// ───────────────────────────────────────────────────────────────

CREATE (capec:CAPEC {
  capecId: 'CAPEC-242',
  name: 'Code Injection',
  description: 'An adversary exploits a weakness in input validation on the target to inject new code into that which is currently executing.',
  abstraction: 'STANDARD',
  likelihood: 'MEDIUM',
  severity: 'VERY_HIGH',
  prerequisites: ['Target application does not perform sufficient input validation', 'User input is used to construct executable code'],
  is_shared: true,
  customer_namespace: 'shared:capec'
});

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: Technique (MITRE ATT&CK)
// ───────────────────────────────────────────────────────────────
// Properties:
//   techniqueId: string (e.g., "T1190") - UNIQUE CONSTRAINT
//   name: string
//   description: string
//   tactic: string[] (e.g., ["initial-access", "execution"])
//   platform: string[] (e.g., ["Windows", "Linux", "Network"])
//   data_sources: string[]
//   detection: string
//   mitigation: string[]
//   is_subtechnique: boolean
//   parent_technique: string (if subtechnique)
//   is_shared: boolean (always true)
//   customer_namespace: "shared:attack"
// ───────────────────────────────────────────────────────────────

CREATE (technique:Technique {
  techniqueId: 'T1190',
  name: 'Exploit Public-Facing Application',
  description: 'Adversaries may attempt to take advantage of a weakness in an Internet-facing computer or program using software, data, or commands in order to cause unintended or unanticipated behavior.',
  tactic: ['initial-access'],
  platform: ['Linux', 'Windows', 'Network', 'Containers', 'IaaS'],
  data_sources: ['Application Log: Application Log Content', 'Network Traffic: Network Traffic Content'],
  detection: 'Monitor application logs for abnormal behavior. Use intrusion detection systems and network monitoring.',
  is_subtechnique: false,
  is_shared: true,
  customer_namespace: 'shared:attack'
});

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: ThreatActor (APT groups, cybercriminal organizations)
// ───────────────────────────────────────────────────────────────
// Properties:
//   id: UUID - UNIQUE CONSTRAINT
//   name: string (e.g., "APT29", "Lazarus Group")
//   aliases: string[]
//   description: string
//   first_seen: date
//   last_seen: date
//   primary_motivation: enum [FINANCIAL, ESPIONAGE, SABOTAGE, IDEOLOGY, REVENGE]
//   sophistication: enum [NOVICE, PRACTITIONER, EXPERT, INNOVATOR, STRATEGIC]
//   resource_level: enum [INDIVIDUAL, CLUB, CONTEST, TEAM, ORGANIZATION, GOVERNMENT]
//   targeted_sectors: string[] (e.g., ["energy", "government", "healthcare"])
//   targeted_countries: string[]
//   is_shared: boolean (always true)
//   customer_namespace: "shared:threat-intel"
// ───────────────────────────────────────────────────────────────

CREATE (apt:ThreatActor {
  id: 'threat-actor-apt29',
  name: 'APT29',
  aliases: ['Cozy Bear', 'The Dukes', 'YTTRIUM'],
  description: 'Russian-attributed advanced persistent threat group targeting government, diplomatic, and technology organizations.',
  first_seen: date('2008-01-01'),
  last_seen: date('2024-10-15'),
  primary_motivation: 'ESPIONAGE',
  sophistication: 'STRATEGIC',
  resource_level: 'GOVERNMENT',
  targeted_sectors: ['government', 'diplomatic', 'technology', 'healthcare'],
  targeted_countries: ['USA', 'UK', 'Germany', 'France'],
  is_shared: true,
  customer_namespace: 'shared:threat-intel'
});

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: ThreatActorProfile (Psychometric modeling)
// ───────────────────────────────────────────────────────────────
// Properties:
//   id: UUID
//   threat_actor_id: UUID (foreign key to ThreatActor)
//   intent_primary: string (e.g., "Establish persistent access to diplomatic communications")
//   intent_secondary: string[]
//   modus_operandi: string
//   preferred_tools: string[]
//   preferred_vectors: string[]
//   attack_timing: enum [OPPORTUNISTIC, PLANNED, CAMPAIGN]
//   operational_tempo: enum [SLOW_AND_METHODICAL, MODERATE, FAST_AND_AGGRESSIVE]
//   risk_tolerance: enum [LOW, MEDIUM, HIGH]
//   anti_forensics_capability: enum [LOW, MEDIUM, HIGH, ADVANCED]
//   psychological_profile: string (behavioral analysis)
// ───────────────────────────────────────────────────────────────

CREATE (profile:ThreatActorProfile {
  id: 'profile-apt29-001',
  threat_actor_id: 'threat-actor-apt29',
  intent_primary: 'Long-term intelligence collection from government and diplomatic targets',
  intent_secondary: ['Technology transfer', 'Geopolitical intelligence', 'COVID-19 vaccine research theft'],
  modus_operandi: 'Multi-stage intrusion with stealthy persistence mechanisms and legitimate credential abuse',
  preferred_tools: ['SUNBURST', 'Cobalt Strike', 'PowerShell', 'WMI'],
  preferred_vectors: ['Spear-phishing', 'Supply chain compromise', 'Cloud infrastructure exploitation'],
  attack_timing: 'CAMPAIGN',
  operational_tempo: 'SLOW_AND_METHODICAL',
  risk_tolerance: 'LOW',
  anti_forensics_capability: 'ADVANCED',
  psychological_profile: 'Patient, disciplined, state-sponsored operators with long-term strategic objectives. Demonstrate high operational security and adaptability. Willing to invest months in reconnaissance before initial access.'
});

// ───────────────────────────────────────────────────────────────
// NODE SCHEMA: Exploit (Weaponized proof-of-concept)
// ───────────────────────────────────────────────────────────────
// Properties:
//   id: UUID
//   name: string
//   cveId: string (reference to CVE)
//   exploit_type: enum [REMOTE, LOCAL, WEB, PHYSICAL]
//   source: enum [METASPLOIT, EXPLOIT_DB, GITHUB, COMMERCIAL, IN_THE_WILD]
//   source_url: string
//   metasploit_module: string (if applicable)
//   verified: boolean
//   reliability: enum [UNRELIABLE, USUALLY_RELIABLE, RELIABLE, CONFIRMED]
//   is_shared: boolean (always true)
//   customer_namespace: "shared:exploits"
// ───────────────────────────────────────────────────────────────

CREATE (exploit:Exploit {
  id: 'exploit-vmware-workspace-rce',
  name: 'VMware Workspace ONE Access SSTI RCE',
  cveId: 'CVE-2022-22954',
  exploit_type: 'REMOTE',
  source: 'METASPLOIT',
  source_url: 'https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/http/vmware_workspace_one_access_cve_2022_22954.rb',
  metasploit_module: 'exploit/linux/http/vmware_workspace_one_access_cve_2022_22954',
  verified: true,
  reliability: 'CONFIRMED',
  is_shared: true,
  customer_namespace: 'shared:exploits'
});

// ═══════════════════════════════════════════════════════════════
// RELATIONSHIP PATTERNS - Layer 4 (20+ Hop Attack Chains)
// ═══════════════════════════════════════════════════════════════

// CVE → CWE (weakness classification)
CREATE (cve)-[:IS_WEAKNESS_TYPE]->(cwe);

// CVE → CAPEC (attack pattern mapping)
CREATE (cve)-[:ENABLES_ATTACK_PATTERN]->(capec);

// CAPEC → CWE (attack pattern exploits weakness)
CREATE (capec)-[:EXPLOITS_WEAKNESS]->(cwe);

// CAPEC → Technique (attack pattern maps to ATT&CK technique)
CREATE (capec)-[:MAPS_TO_TECHNIQUE]->(technique);

// CVE → Exploit (CVE has weaponized exploit)
CREATE (cve)-[:HAS_EXPLOIT]->(exploit);

// Exploit → ThreatActor (threat actor uses exploit)
CREATE (exploit)-[:USED_BY_THREAT_ACTOR]->(apt);

// ThreatActor → Technique (threat actor uses ATT&CK technique)
CREATE (apt)-[:USES_TTP]->(technique);

// ThreatActor → ThreatActorProfile (psychometric profiling)
CREATE (apt)-[:HAS_PROFILE]->(profile);

// ───────────────────────────────────────────────────────────────
// Link to Software (from Layer 3) - Multi-Layer Integration
// ───────────────────────────────────────────────────────────────

// Example: VMware Workspace ONE Access software
CREATE (vmware_software:Software {
  id: 'software-vmware-workspace-one-21.08',
  name: 'VMware Workspace ONE Access',
  vendor: 'VMware',
  product: 'Workspace ONE Access',
  version: '21.08.0.0',
  cpe: 'cpe:2.3:a:vmware:workspace_one_access:21.08.0.0:*:*:*:*:*:*:*',
  customer_namespace: 'customer:EnterpriseCorp'
});

// Software → CVE (software has vulnerability)
CREATE (vmware_software)-[:HAS_VULNERABILITY {
  affected_versions: ['21.08.0.0', '21.08.0.1', '20.10.0.0'],
  fixed_in_version: '21.08.0.2',
  patch_available: true,
  workaround_available: false
}]->(cve);

// ═══════════════════════════════════════════════════════════════
// QUERY EXAMPLES - Multi-Hop Attack Chain Traversal
// ═══════════════════════════════════════════════════════════════

// Example 1: Find complete attack chain (8-hop query)
// Software → CVE → CWE → CAPEC → Technique → ThreatActor → Profile
MATCH path = (s:Software {customer_namespace: 'customer:EnterpriseCorp'})
  -[:HAS_VULNERABILITY]->(cve:CVE)
  -[:IS_WEAKNESS_TYPE]->(cwe:CWE)
  <-[:EXPLOITS_WEAKNESS]-(capec:CAPEC)
  -[:MAPS_TO_TECHNIQUE]->(tech:Technique)
  <-[:USES_TTP]-(ta:ThreatActor)
  -[:HAS_PROFILE]->(profile:ThreatActorProfile)
WHERE cve.cvssV3BaseScore >= 9.0
  AND cve.hasExploit = true
RETURN s.name AS vulnerable_software,
       cve.cveId AS vulnerability,
       cve.cvssV3BaseScore AS severity,
       tech.name AS attack_technique,
       ta.name AS threat_actor,
       profile.intent_primary AS actor_intent,
       length(path) AS hops;

// Example 2: Find all threat actors targeting specific software
MATCH (s:Software {name: 'VMware Workspace ONE Access'})
  -[:HAS_VULNERABILITY]->(cve:CVE)
  -[:HAS_EXPLOIT]->(e:Exploit)
  -[:USED_BY_THREAT_ACTOR]->(ta:ThreatActor)
WHERE cve.hasExploit = true
RETURN ta.name AS threat_actor,
       ta.sophistication AS sophistication,
       ta.primary_motivation AS motivation,
       collect(DISTINCT cve.cveId) AS exploited_cves;

// Example 3: Psychometric-based threat actor analysis
MATCH (ta:ThreatActor)-[:HAS_PROFILE]->(p:ThreatActorProfile)
WHERE p.operational_tempo = 'SLOW_AND_METHODICAL'
  AND p.risk_tolerance = 'LOW'
  AND ta.sophistication IN ['STRATEGIC', 'EXPERT']
RETURN ta.name AS actor,
       ta.resource_level AS resources,
       p.intent_primary AS intent,
       p.preferred_vectors AS vectors,
       p.psychological_profile AS behavioral_analysis;

// ═══════════════════════════════════════════════════════════════
// VALIDATION METRICS
// ═══════════════════════════════════════════════════════════════

// CVE severity distribution
MATCH (cve:CVE)
RETURN cve.cvssV3Severity AS severity,
       count(cve) AS count,
       avg(cve.cvssV3BaseScore) AS avg_score
ORDER BY avg_score DESC;

// Threat actor sophistication distribution
MATCH (ta:ThreatActor)
RETURN ta.sophistication AS sophistication,
       count(ta) AS actor_count
ORDER BY actor_count DESC;

// Most exploited attack techniques
MATCH (ta:ThreatActor)-[:USES_TTP]->(t:Technique)
RETURN t.name AS technique,
       t.techniqueId AS technique_id,
       count(DISTINCT ta) AS threat_actor_count
ORDER BY threat_actor_count DESC
LIMIT 10;
