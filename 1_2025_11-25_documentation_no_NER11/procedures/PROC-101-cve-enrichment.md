# PROCEDURE: [PROC-101] CVE Enrichment from NVD API

**Procedure ID**: PROC-101
**Version**: 1.0.0
**Created**: 2025-11-26
**Last Modified**: 2025-11-26
**Author**: AEON ETL Agent System
**Status**: APPROVED

---

## 1. METADATA

| Field | Value |
|-------|-------|
| **Category** | ETL |
| **Frequency** | DAILY (incremental) / ON-DEMAND (full refresh) |
| **Priority** | CRITICAL |
| **Estimated Duration** | 4-6 hours (full), 15-30 min (incremental) |
| **Risk Level** | LOW |
| **Rollback Available** | YES |

---

## 2. PURPOSE & OBJECTIVES

### 2.1 Purpose Statement
Enrich existing CVE nodes with CVSS v3.1 scores, CWE mappings, and additional vulnerability metadata from the NVD API 2.0, and create CVE→CWE relationships essential for the 8-hop attack chain.

### 2.2 Business Objectives
- [x] Enrich 215,780 CVEs currently missing severity scores (70% of dataset)
- [x] Create IS_WEAKNESS_TYPE relationships linking CVEs to CWE weaknesses
- [x] Add exploitability and impact scores for risk prioritization
- [x] Enable CVSS-based filtering for McKenney Q3/Q5/Q8 queries

### 2.3 McKenney Questions Addressed
| Question | How Addressed |
|----------|---------------|
| Q1: What equipment do we have? | N/A |
| Q2: What equipment do customers have? | N/A |
| Q3: What do attackers know? | CVE severity reveals exploitability knowledge |
| Q4: Who are the attackers? | N/A (see PROC-501) |
| Q5: How do we defend? | CVSS scores prioritize patching efforts |
| Q6: What happened before? | Exploit history via hasExploit flag |
| Q7: What will happen next? | exploitabilityScore predicts future attacks |
| Q8: What should we do? | Severity-based mitigation prioritization |

---

## 3. PRE-CONDITIONS

### 3.1 Infrastructure Requirements

| Component | Required State | Verification Command |
|-----------|---------------|---------------------|
| Neo4j | Running, accessible | `docker ps \| grep neo4j` |
| OpenSPG Server | Healthy | `curl http://localhost:8887/health` |
| Network | Internet access for NVD API | `curl -I https://services.nvd.nist.gov` |

### 3.2 Data Pre-Conditions

| Condition | Verification Query/Command | Expected Result |
|-----------|---------------------------|-----------------|
| CVE nodes exist | `MATCH (c:CVE) RETURN count(c)` | >= 307,322 |
| CWE nodes exist | `MATCH (c:CWE) RETURN count(c)` | >= 10 (will create more) |
| CVEs need enrichment | `MATCH (c:CVE) WHERE c.severity IS NULL OR c.severity = '' RETURN count(c)` | ~215,780 |

### 3.3 Authentication & Credentials

| Service | Credential Source | Environment Variable |
|---------|------------------|---------------------|
| Neo4j | Docker compose | `NEO4J_PASSWORD=neo4j@openspg` |
| NVD API | Optional API key | `NVD_API_KEY` (increases rate limit) |

### 3.4 Dependencies

| Dependency | Version Required | Verification |
|------------|-----------------|--------------|
| Python | 3.9+ | `python --version` |
| neo4j (Python) | 5.x | `pip show neo4j` |
| requests | 2.x | `pip show requests` |
| python-dotenv | 1.x | `pip show python-dotenv` |

### 3.5 Prior Procedures Required

| Procedure ID | Procedure Name | Must Complete Before |
|--------------|---------------|---------------------|
| PROC-001 | Schema Migration | This procedure (constraints must exist) |

---

## 4. DATA SOURCES

### 4.1 Source Overview

| Source Name | Type | Location | Format | Update Frequency |
|-------------|------|----------|--------|------------------|
| NVD API 2.0 | REST API | https://services.nvd.nist.gov/rest/json/cves/2.0 | JSON | Real-time |

### 4.2 Source Details

#### Source 1: NVD Vulnerability API 2.0

**Connection Information**:
```
Type: REST API
URL: https://services.nvd.nist.gov/rest/json/cves/2.0
Authentication: API Key (optional, increases rate from 5 to 50 req/30sec)
Rate Limits: 5 requests/30 seconds (no key) or 50 requests/30 seconds (with key)
```

**Data Schema**:
```json
{
  "vulnerabilities": [
    {
      "cve": {
        "id": "CVE-2024-12345",
        "descriptions": [{"lang": "en", "value": "Description text"}],
        "metrics": {
          "cvssMetricV31": [{
            "cvssData": {
              "baseScore": 9.8,
              "baseSeverity": "CRITICAL",
              "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
              "exploitabilityScore": 3.9,
              "impactScore": 5.9
            }
          }]
        },
        "weaknesses": [{
          "description": [{"value": "CWE-79"}]
        }],
        "published": "2024-01-15T12:00:00.000",
        "lastModified": "2024-01-20T14:30:00.000"
      }
    }
  ]
}
```

**Sample Data**:
```json
{
  "cve": {
    "id": "CVE-2024-21762",
    "metrics": {
      "cvssMetricV31": [{
        "cvssData": {
          "baseScore": 9.8,
          "baseSeverity": "CRITICAL",
          "exploitabilityScore": 3.9,
          "impactScore": 5.9
        }
      }]
    },
    "weaknesses": [{"description": [{"value": "CWE-787"}]}]
  }
}
```

**Extraction Query/Command**:
```bash
# Single CVE lookup
curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=CVE-2024-21762" \
  -H "apiKey: $NVD_API_KEY"

# Batch by date range (incremental)
curl -s "https://services.nvd.nist.gov/rest/json/cves/2.0?lastModStartDate=2025-01-01T00:00:00.000&lastModEndDate=2025-01-31T23:59:59.999" \
  -H "apiKey: $NVD_API_KEY"
```

### 4.3 Data Volume Estimates

| Source | Records Expected | Size Estimate | Processing Time |
|--------|-----------------|---------------|-----------------|
| NVD API (full) | 215,780 CVEs | ~2GB JSON | 4-6 hours |
| NVD API (daily) | ~50-200 CVEs | ~5MB JSON | 5-15 minutes |

---

## 5. DESTINATION

### 5.1 Target System

| Field | Value |
|-------|-------|
| **System** | Neo4j |
| **Container** | openspg-neo4j (or neo4j-explore) |
| **Host** | localhost |
| **Port** | 7687 (Bolt), 7474 (HTTP) |
| **Database** | neo4j (default) |
| **Schema** | AEON 8-Layer Architecture |

### 5.2 Connection Details

```
Protocol: bolt://
Host: localhost
Port: 7687
Database: neo4j
User: neo4j
Password: ${NEO4J_PASSWORD:-neo4j@openspg}
```

### 5.3 Target Schema

#### Node Types Created/Modified

| Label | Properties | Constraints | Indexes |
|-------|-----------|-------------|---------|
| CVE | cvssV3BaseScore, cvssV3Severity, cvssV3Vector, exploitabilityScore, impactScore, hasExploit, enriched_timestamp | cve_id_unique | cve_severity_idx, cve_score_idx |
| CWE | id, name, description, source | cwe_id_unique | cwe_name_idx |

#### Relationship Types Created/Modified

| Type | Source | Target | Properties |
|------|--------|--------|------------|
| IS_WEAKNESS_TYPE | (:CVE) | (:CWE) | source, created_timestamp |

### 5.4 Target Data Location

**Exact Storage Path**:
```
Container: openspg-neo4j (or neo4j-explore)
Volume: active_neo4j_data
Internal Path: /data/databases/neo4j
External Mount: /var/lib/docker/volumes/active_neo4j_data/_data
```

---

## 6. TRANSFORMATION LOGIC

### 6.1 Mapping Rules

| Source Field | Target Property | Transformation |
|--------------|-----------------|----------------|
| cve.id | CVE.cve_id | Direct copy (existing) |
| metrics.cvssMetricV31[0].cvssData.baseScore | CVE.cvssV3BaseScore | Extract from nested, round to 1 decimal |
| metrics.cvssMetricV31[0].cvssData.baseSeverity | CVE.cvssV3Severity | UPPER(value) |
| metrics.cvssMetricV31[0].cvssData.vectorString | CVE.cvssV3Vector | Direct copy |
| metrics.cvssMetricV31[0].cvssData.exploitabilityScore | CVE.exploitabilityScore | Extract, round to 2 decimals |
| metrics.cvssMetricV31[0].cvssData.impactScore | CVE.impactScore | Extract, round to 2 decimals |
| weaknesses[*].description[*].value | CWE.id | Extract CWE-XXX, create if not exists |
| [calculated] | CVE.enriched_timestamp | datetime() at enrichment time |
| [calculated] | CVE.customer_namespace | "shared:nvd" |

### 6.2 Data Validation Rules

| Rule ID | Field | Validation | Action on Failure |
|---------|-------|------------|------------------|
| VAL-001 | cve.id | REGEX `^CVE-\d{4}-\d{4,}$` | REJECT record |
| VAL-002 | baseScore | Range 0.0-10.0 | WARN and set NULL |
| VAL-003 | baseSeverity | IN ['NONE','LOW','MEDIUM','HIGH','CRITICAL'] | DEFAULT to MEDIUM |
| VAL-004 | CWE ID | REGEX `^CWE-\d+$` | SKIP relationship |

### 6.3 Deduplication Strategy

```
Unique Key: CVE.cve_id
On Duplicate: MERGE (update properties)
Merge Strategy: Newer data overwrites older, preserve enriched_timestamp
```

### 6.4 Error Handling

| Error Type | Detection | Action | Logging |
|------------|-----------|--------|---------|
| API rate limit | HTTP 403/429 | Wait 30s, retry with backoff | INFO level |
| API timeout | No response 60s | Retry 3x, skip and log | WARN level |
| Invalid JSON | Parse exception | Skip record, continue | ERROR level |
| Missing CVSS | Empty metrics | Keep existing values | DEBUG level |
| Neo4j connection | Driver exception | Retry 3x with backoff | ERROR level |

---

## 7. EXECUTION STEPS

### 7.1 Pre-Execution Checklist

- [ ] All pre-conditions verified
- [ ] NVD_API_KEY available (optional but recommended)
- [ ] NEO4J_PASSWORD set correctly
- [ ] Network connectivity to NVD API confirmed
- [ ] Sufficient disk space (>1GB free)

### 7.2 Step-by-Step Execution

#### Step 1: Verify Neo4j Connectivity

**Purpose**: Ensure database is accessible and contains CVE data

**Command**:
```bash
docker exec openspg-neo4j cypher-shell -u neo4j -p "neo4j@openspg" \
  "MATCH (c:CVE) WHERE c.severity IS NULL OR c.severity = '' RETURN count(c) AS unenriched_count"
```

**Expected Output**:
```
+------------------+
| unenriched_count |
+------------------+
| 215780           |
+------------------+
```

**Verification**:
```bash
# Confirm number is significant (>10000)
```

**Troubleshooting**:
- If connection refused: Check container is running with `docker ps`
- If auth failed: Verify password in docker-compose.yml

---

#### Step 2: Create/Update CWE Constraints

**Purpose**: Ensure CWE uniqueness constraint exists before creating nodes

**Command**:
```bash
docker exec openspg-neo4j cypher-shell -u neo4j -p "neo4j@openspg" \
  "CREATE CONSTRAINT cwe_id_unique IF NOT EXISTS FOR (c:CWE) REQUIRE c.id IS UNIQUE"
```

**Expected Output**:
```
0 rows
```

**Verification**:
```bash
docker exec openspg-neo4j cypher-shell -u neo4j -p "neo4j@openspg" \
  "SHOW CONSTRAINTS WHERE name = 'cwe_id_unique'"
```

---

#### Step 3: Run CVE Enrichment Script

**Purpose**: Fetch NVD data and update Neo4j

**Command**:
```bash
cd /home/jim/2_OXOT_Projects_Dev/scripts/etl
python3 proc_101_cve_enrichment.py --mode incremental
```

**Expected Output**:
```
[INFO] Starting CVE enrichment procedure PROC-101
[INFO] Mode: incremental
[INFO] Found 215780 CVEs needing enrichment
[INFO] Processing batch 1/216 (1000 CVEs)
[INFO] API call successful, processing results...
[INFO] Updated 987 CVEs, created 145 CWE relationships
...
[INFO] PROC-101 completed successfully
[INFO] Total CVEs enriched: 214500
[INFO] Total CWE relationships created: 185000
[INFO] Errors: 1280 (0.6%)
```

**Verification**:
```bash
docker exec openspg-neo4j cypher-shell -u neo4j -p "neo4j@openspg" \
  "MATCH (c:CVE) WHERE c.enriched_timestamp IS NOT NULL RETURN count(c)"
```

**Troubleshooting**:
- If rate limited: Add NVD_API_KEY or increase delay between requests
- If timeout: Check network, retry failed batches

---

#### Step 4: Verify CVE→CWE Relationships

**Purpose**: Confirm attack chain linkage is working

**Command**:
```bash
docker exec openspg-neo4j cypher-shell -u neo4j -p "neo4j@openspg" \
  "MATCH (cve:CVE)-[r:IS_WEAKNESS_TYPE]->(cwe:CWE) RETURN count(r) AS relationship_count"
```

**Expected Output**:
```
+--------------------+
| relationship_count |
+--------------------+
| 185000+            |
+--------------------+
```

**Verification**:
```bash
# Sample query to verify chain works
docker exec openspg-neo4j cypher-shell -u neo4j -p "neo4j@openspg" \
  "MATCH (cve:CVE)-[:IS_WEAKNESS_TYPE]->(cwe:CWE)
   WHERE cve.cvssV3Severity = 'CRITICAL'
   RETURN cve.cve_id, cwe.id LIMIT 5"
```

---

### 7.3 Complete Execution Script

```bash
#!/bin/bash
# PROCEDURE: PROC-101 - CVE Enrichment from NVD API
# Version: 1.0.0
# Execute: ./proc_101_cve_enrichment.sh [full|incremental]

set -e

# Configuration
NEO4J_HOST="localhost"
NEO4J_PORT="7687"
NEO4J_USER="neo4j"
NEO4J_PASS="${NEO4J_PASSWORD:-neo4j@openspg}"
NEO4J_CONTAINER="${NEO4J_CONTAINER:-openspg-neo4j}"
NVD_API_KEY="${NVD_API_KEY:-}"

MODE="${1:-incremental}"
LOG_FILE="/var/log/aeon/proc_101_$(date +%Y%m%d_%H%M%S).log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Functions
log_info() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [INFO] $1" | tee -a "$LOG_FILE"; }
log_error() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [ERROR] $1" | tee -a "$LOG_FILE"; }
log_warn() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] [WARN] $1" | tee -a "$LOG_FILE"; }

cypher_query() {
    docker exec "$NEO4J_CONTAINER" cypher-shell -u "$NEO4J_USER" -p "$NEO4J_PASS" "$1"
}

check_preconditions() {
    log_info "Checking pre-conditions..."

    # Check Neo4j running
    if ! docker ps | grep -q "$NEO4J_CONTAINER"; then
        log_error "Neo4j container not running"
        return 1
    fi

    # Check Neo4j accessible
    if ! cypher_query "RETURN 1" > /dev/null 2>&1; then
        log_error "Cannot connect to Neo4j"
        return 1
    fi

    # Check CVE data exists
    CVE_COUNT=$(cypher_query "MATCH (c:CVE) RETURN count(c)" | tail -1 | tr -d ' ')
    if [ "$CVE_COUNT" -lt 1000 ]; then
        log_error "Insufficient CVE data: $CVE_COUNT"
        return 1
    fi

    log_info "Pre-conditions verified. CVE count: $CVE_COUNT"
}

create_constraints() {
    log_info "Creating/verifying constraints..."
    cypher_query "CREATE CONSTRAINT cwe_id_unique IF NOT EXISTS FOR (c:CWE) REQUIRE c.id IS UNIQUE"
    cypher_query "CREATE INDEX cve_enriched_idx IF NOT EXISTS FOR (c:CVE) ON (c.enriched_timestamp)"
}

run_enrichment() {
    log_info "Running CVE enrichment in $MODE mode..."

    cd "$SCRIPT_DIR"
    python3 proc_101_cve_enrichment.py \
        --mode "$MODE" \
        --neo4j-host "$NEO4J_HOST" \
        --neo4j-port "$NEO4J_PORT" \
        --neo4j-user "$NEO4J_USER" \
        --neo4j-pass "$NEO4J_PASS" \
        ${NVD_API_KEY:+--api-key "$NVD_API_KEY"} \
        2>&1 | tee -a "$LOG_FILE"
}

verify_results() {
    log_info "Verifying enrichment results..."

    ENRICHED=$(cypher_query "MATCH (c:CVE) WHERE c.enriched_timestamp IS NOT NULL RETURN count(c)" | tail -1)
    CWE_RELS=$(cypher_query "MATCH ()-[r:IS_WEAKNESS_TYPE]->() RETURN count(r)" | tail -1)

    log_info "Enriched CVEs: $ENRICHED"
    log_info "CVE→CWE relationships: $CWE_RELS"
}

main() {
    mkdir -p /var/log/aeon
    log_info "Starting PROC-101: CVE Enrichment from NVD API"
    log_info "Mode: $MODE"

    check_preconditions || exit 1
    create_constraints
    run_enrichment
    verify_results

    log_info "PROC-101 completed successfully"
}

main "$@"
```

---

## 8. POST-EXECUTION

### 8.1 Verification Queries

#### Verify Enrichment Count

```cypher
// Count enriched CVEs
MATCH (c:CVE)
WHERE c.enriched_timestamp IS NOT NULL
RETURN count(c) AS enriched_count;
```

**Expected Result**: >= 200,000

#### Verify Severity Distribution

```cypher
// Check severity distribution improved
MATCH (c:CVE)
WHERE c.cvssV3Severity IS NOT NULL
RETURN c.cvssV3Severity AS severity, count(c) AS count
ORDER BY count DESC;
```

**Expected Result**:
```
| severity | count   |
|----------|---------|
| MEDIUM   | 80000+  |
| HIGH     | 60000+  |
| CRITICAL | 15000+  |
| LOW      | 10000+  |
```

#### Verify CWE Relationships

```cypher
// Count CVE→CWE relationships
MATCH (cve:CVE)-[r:IS_WEAKNESS_TYPE]->(cwe:CWE)
RETURN count(r) AS total_relationships,
       count(DISTINCT cve) AS cves_with_cwe,
       count(DISTINCT cwe) AS unique_cwes;
```

**Expected Result**: 150,000+ relationships

### 8.2 Success Criteria

| Criterion | Measurement | Threshold | Actual |
|-----------|-------------|-----------|--------|
| CVEs enriched | Count with enriched_timestamp | >= 200,000 | [To fill] |
| Error rate | % failures | < 5% | [To fill] |
| Execution time | Minutes | < 360 (full) | [To fill] |
| CWE relationships | Count of IS_WEAKNESS_TYPE | >= 150,000 | [To fill] |
| Severity coverage | % CVEs with severity | >= 90% | [To fill] |

### 8.3 Cleanup Tasks

- [ ] Archive API response logs older than 7 days
- [ ] Clear temporary batch files
- [ ] Update procedure execution log
- [ ] Notify downstream procedures (PROC-201)

---

## 9. ROLLBACK PROCEDURE

### 9.1 Rollback Triggers

- Error rate exceeds 20%
- Neo4j performance degradation detected
- Invalid data corruption discovered
- User requests rollback

### 9.2 Rollback Steps

#### Step 1: Identify Affected Data

```cypher
// Find CVEs modified by this run
MATCH (c:CVE)
WHERE c.enriched_timestamp > datetime('2025-11-26T00:00:00')
RETURN count(c) AS affected_cves;
```

#### Step 2: Remove Enrichment Data

```cypher
// Remove CVE→CWE relationships from this run
MATCH (cve:CVE)-[r:IS_WEAKNESS_TYPE]->(cwe:CWE)
WHERE r.created_timestamp > datetime('2025-11-26T00:00:00')
DELETE r;

// Reset enrichment properties
MATCH (c:CVE)
WHERE c.enriched_timestamp > datetime('2025-11-26T00:00:00')
REMOVE c.cvssV3BaseScore, c.cvssV3Severity, c.cvssV3Vector,
       c.exploitabilityScore, c.impactScore, c.enriched_timestamp;
```

#### Step 3: Verify Rollback

```cypher
// Confirm rollback complete
MATCH (c:CVE)
WHERE c.enriched_timestamp > datetime('2025-11-26T00:00:00')
RETURN count(c);
// Expected: 0
```

### 9.3 Rollback Verification

```cypher
// Verify system returned to pre-enrichment state
MATCH (c:CVE) WHERE c.severity IS NULL OR c.severity = ''
RETURN count(c) AS unenriched_count;
// Should return to original ~215,780
```

---

## 10. SCHEDULING & AUTOMATION

### 10.1 Cron Schedule

```cron
# Daily incremental enrichment at 3 AM
0 3 * * * /home/jim/2_OXOT_Projects_Dev/scripts/etl/proc_101_cve_enrichment.sh incremental >> /var/log/aeon/proc_101_cron.log 2>&1

# Weekly full refresh on Sundays at 1 AM
0 1 * * 0 /home/jim/2_OXOT_Projects_Dev/scripts/etl/proc_101_cve_enrichment.sh full >> /var/log/aeon/proc_101_cron.log 2>&1
```

### 10.2 Trigger Conditions

| Trigger | Source | Action |
|---------|--------|--------|
| New CVE detected | NVD feed | Execute incremental |
| CVSS score update | NVD API | Re-enrich affected CVE |
| Manual request | Admin | Execute specified mode |

### 10.3 Dependencies in Pipeline

```
PROC-001 (Schema Setup)
    ↓
PROC-101 (CVE Enrichment) ← YOU ARE HERE
    ↓
PROC-201 (CWE-CAPEC Linking)
    ↓
PROC-301 (CAPEC-ATT&CK Mapping)
    ↓
PROC-901 (Attack Chain Validation)
```

---

## 11. MONITORING & ALERTING

### 11.1 Metrics to Monitor

| Metric | Source | Threshold | Alert |
|--------|--------|-----------|-------|
| Execution duration | Log | > 8 hours (full) | WARN |
| Error rate | Log | > 5% | ERROR |
| API rate limit hits | Log | > 100/run | WARN |
| CVEs enriched | Neo4j | < 1000/day | ERROR |

### 11.2 Log Locations

| Log Type | Location | Retention |
|----------|----------|-----------|
| Execution log | `/var/log/aeon/proc_101_*.log` | 30 days |
| Error log | `/var/log/aeon/proc_101_error.log` | 90 days |
| Cron log | `/var/log/aeon/proc_101_cron.log` | 30 days |

### 11.3 Alert Channels

| Severity | Channel | Recipients |
|----------|---------|------------|
| CRITICAL | Log + Console | Immediate attention |
| ERROR | Log file | Daily review |
| WARN | Log file | Weekly review |

---

## 12. CHANGE HISTORY

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0.0 | 2025-11-26 | AEON ETL Agent | Initial version |

---

## 13. APPENDICES

### Appendix A: NVD API Response Sample

```json
{
  "resultsPerPage": 1,
  "startIndex": 0,
  "totalResults": 1,
  "format": "NVD_CVE",
  "version": "2.0",
  "timestamp": "2025-01-15T12:00:00.000",
  "vulnerabilities": [{
    "cve": {
      "id": "CVE-2024-21762",
      "sourceIdentifier": "psirt@fortinet.com",
      "published": "2024-02-09T00:00:00.000",
      "lastModified": "2024-02-10T14:30:00.000",
      "vulnStatus": "Analyzed",
      "descriptions": [{
        "lang": "en",
        "value": "A out-of-bounds write in Fortinet FortiOS..."
      }],
      "metrics": {
        "cvssMetricV31": [{
          "source": "nvd@nist.gov",
          "type": "Primary",
          "cvssData": {
            "version": "3.1",
            "vectorString": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
            "attackVector": "NETWORK",
            "attackComplexity": "LOW",
            "privilegesRequired": "NONE",
            "userInteraction": "NONE",
            "scope": "UNCHANGED",
            "confidentialityImpact": "HIGH",
            "integrityImpact": "HIGH",
            "availabilityImpact": "HIGH",
            "baseScore": 9.8,
            "baseSeverity": "CRITICAL",
            "exploitabilityScore": 3.9,
            "impactScore": 5.9
          }
        }]
      },
      "weaknesses": [{
        "source": "nvd@nist.gov",
        "type": "Primary",
        "description": [{"lang": "en", "value": "CWE-787"}]
      }]
    }
  }]
}
```

### Appendix B: Python Enrichment Script Structure

```python
#!/usr/bin/env python3
"""
PROC-101: CVE Enrichment from NVD API
Version: 1.0.0
"""

import argparse
import requests
import time
from neo4j import GraphDatabase
from datetime import datetime

class CVEEnrichmentAgent:
    def __init__(self, neo4j_uri, neo4j_user, neo4j_pass, api_key=None):
        self.driver = GraphDatabase.driver(neo4j_uri, auth=(neo4j_user, neo4j_pass))
        self.api_key = api_key
        self.base_url = "https://services.nvd.nist.gov/rest/json/cves/2.0"
        self.delay = 6 if not api_key else 0.6  # Rate limiting

    def get_unenriched_cves(self, limit=1000):
        """Get CVEs needing enrichment"""
        with self.driver.session() as session:
            result = session.run("""
                MATCH (c:CVE)
                WHERE c.enriched_timestamp IS NULL
                RETURN c.cve_id AS cve_id
                LIMIT $limit
            """, limit=limit)
            return [r["cve_id"] for r in result]

    def fetch_nvd_data(self, cve_id):
        """Fetch CVE data from NVD API"""
        headers = {"apiKey": self.api_key} if self.api_key else {}
        response = requests.get(f"{self.base_url}?cveId={cve_id}", headers=headers)
        time.sleep(self.delay)
        return response.json() if response.ok else None

    def enrich_cve(self, cve_id, nvd_data):
        """Update CVE node with NVD data"""
        # Extract CVSS metrics
        # Create CWE nodes and relationships
        # Update CVE properties
        pass

    def run(self, mode="incremental"):
        """Main execution"""
        cves = self.get_unenriched_cves()
        for cve_id in cves:
            nvd_data = self.fetch_nvd_data(cve_id)
            if nvd_data:
                self.enrich_cve(cve_id, nvd_data)

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("--mode", default="incremental")
    parser.add_argument("--neo4j-host", default="localhost")
    parser.add_argument("--neo4j-port", default="7687")
    parser.add_argument("--neo4j-user", default="neo4j")
    parser.add_argument("--neo4j-pass", required=True)
    parser.add_argument("--api-key", default=None)
    args = parser.parse_args()

    agent = CVEEnrichmentAgent(
        f"bolt://{args.neo4j_host}:{args.neo4j_port}",
        args.neo4j_user, args.neo4j_pass, args.api_key
    )
    agent.run(args.mode)
```

### Appendix C: Troubleshooting Guide

| Symptom | Possible Cause | Solution |
|---------|---------------|----------|
| API returns 403 | Rate limited | Add API key or increase delay |
| API returns empty | CVE not in NVD | Skip, may be reserved |
| Neo4j timeout | Large batch | Reduce batch size |
| Missing CVSS | Old CVE | Use CVSS v2 fallback |
| Duplicate CWE | Constraint missing | Run Step 2 first |

### Appendix D: Related Documentation

| Document | Location | Relationship |
|----------|----------|--------------|
| ACTUAL_NEO4J_SCHEMA.md | technical_specs/ | Current schema state |
| SCHEMA_RECONCILIATION_ANALYSIS.md | technical_specs/ | Gap analysis |
| 04_layer_vulnerability_threat.cypher | schemas/neo4j/ | Target schema |
| PROC-201 | procedures/ | Next in pipeline |

---

**End of Procedure PROC-101**
