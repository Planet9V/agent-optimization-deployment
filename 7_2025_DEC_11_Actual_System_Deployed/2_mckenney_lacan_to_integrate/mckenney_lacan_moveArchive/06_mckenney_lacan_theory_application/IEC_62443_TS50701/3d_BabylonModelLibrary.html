<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Engineering Model Library</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
        }

        /* Sidebar Styling */
        #libraryPanel {
            width: 300px;
            background-color: #252526;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        #libraryHeader {
            padding: 20px;
            background-color: #007acc;
            color: white;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #fileList {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #ccc;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: all 0.2s;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .file-item:hover {
            background-color: #37373d;
            color: white;
            padding-left: 20px; /* Slide effect */
        }

        .file-item.active {
            background-color: #0e639c;
            color: white;
            border-left: 4px solid #fff;
        }

        .icon-box {
            width: 24px;
            height: 24px;
            background: #444;
            margin-right: 10px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #888;
        }

        /* 3D Viewport Styling */
        #canvasZone {
            flex-grow: 1;
            position: relative;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
            outline: none;
        }

        /* Status Overlay */
        #statusOverlay {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff88;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            transition: opacity 0.5s;
            opacity: 0;
        }
    </style>
    
    <!-- Load Babylon.js and Loaders -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>
<body>

    <!-- SIDEBAR LIBRARY -->
    <div id="libraryPanel">
        <div id="libraryHeader">
            <span>ðŸ“‚</span> Model Library
        </div>
        <div id="fileList">
            <!-- Items injected by JS -->
        </div>
    </div>

    <!-- MAIN VIEWPORT -->
    <div id="canvasZone">
        <div id="statusOverlay">Loading...</div>
        <canvas id="renderCanvas"></canvas>
    </div>

    <script>
        // --- CONFIGURATION: THE LIBRARY ---
        // Add or remove models here. 
        // rootUrl: The folder path (must end in /)
        // file: The file name
        const library = [
            { 
                name: "BoomBox (Consumer)", 
                rootUrl: "https://playground.babylonjs.com/scenes/", 
                file: "BoomBox.glb" 
            },
            { 
                name: "Aerobatic Plane", 
                rootUrl: "https://models.babylonjs.com/", 
                file: "aerobatic_plane.glb" 
            },
            { 
                name: "Mechanical Buggy", 
                rootUrl: "https://playground.babylonjs.com/scenes/", 
                file: "Buggy/buggy.gltf" 
            },
            { 
                name: "Sci-Fi UFO", 
                rootUrl: "https://models.babylonjs.com/", 
                file: "ufo.glb" 
            },
            { 
                name: "PBR Shader Ball", 
                rootUrl: "https://models.babylonjs.com/", 
                file: "shaderBall.glb" 
            },
            { 
                name: "Flight Helmet", 
                rootUrl: "https://models.babylonjs.com/", 
                file: "flightHelmet.glb" // Replaced broken "powerplant.glb" with this reliable model
            }
        ];

        // --- ENGINE SETUP ---
        const canvas = document.getElementById("renderCanvas");
        const statusOverlay = document.getElementById("statusOverlay");
        const engine = new BABYLON.Engine(canvas, true);
        
        // --- SCENE STATE ---
        let scene = null;
        let camera = null;
        let currentMeshes = [];

        // --- INITIALIZATION ---
        const createBaseScene = () => {
            const newScene = new BABYLON.Scene(engine);
            newScene.clearColor = new BABYLON.Color3(0.12, 0.12, 0.15); // Dark Engineering Grey

            // Camera (starts at 0, will be moved)
            camera = new BABYLON.ArcRotateCamera("camera", 0, 0, 10, BABYLON.Vector3.Zero(), newScene);
            camera.attachControl(canvas, true);
            camera.wheelPrecision = 50;
            camera.minZ = 0.1;

            // Lighting: A mix of Hemispheric (Ambient) and Directional (Sun)
            const hemiLight = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), newScene);
            hemiLight.intensity = 0.6;

            const dirLight = new BABYLON.DirectionalLight("dir", new BABYLON.Vector3(-1, -2, -1), newScene);
            dirLight.position = new BABYLON.Vector3(20, 40, 20);
            dirLight.intensity = 0.8;

            // Environment: Studio reflections
            const envHelper = newScene.createDefaultEnvironment({
                createSkybox: true,
                skyboxSize: 1000,
                skyboxColor: new BABYLON.Color3(0.12, 0.12, 0.15),
                createGround: true,
                groundSize: 1000,
                groundColor: new BABYLON.Color3(0.11, 0.11, 0.14),
                enableGroundShadow: true,
            });
            envHelper.setMainColor(new BABYLON.Color3(0.12, 0.12, 0.15));

            return newScene;
        };

        scene = createBaseScene();

        // --- CORE FUNCTIONS ---

        function showStatus(msg, isError = false) {
            statusOverlay.innerText = msg;
            statusOverlay.style.opacity = "1";
            statusOverlay.style.color = isError ? "#ff5555" : "#00ff88";
            
            // Auto-hide after 3 seconds if it's a success message
            if(!isError && msg !== "Loading...") {
                setTimeout(() => { statusOverlay.style.opacity = "0"; }, 3000);
            }
        }

        async function loadModel(modelIndex) {
            const data = library[modelIndex];
            if (!data) return;

            showStatus(`Loading ${data.name}...`);

            // 1. Cleanup old model
            if (currentMeshes.length > 0) {
                // Dispose all previous meshes
                currentMeshes.forEach(mesh => {
                    // Check if mesh is still in scene before disposing
                    if(!mesh.isDisposed()) mesh.dispose(false, true);
                });
                currentMeshes = [];
                
                // Also clear materials/textures to free memory? 
                // Babylon handles GC mostly, but explicitly:
                scene.materials.forEach(m => {
                    if (m.name !== "skyBox" && m.name !== "BackgroundSkyboxMaterial") {
                        // Keep environment, dispose others
                        // This is optional and aggressive, skipping for safety
                    }
                });
            }

            try {
                // 2. Import New Model
                const result = await BABYLON.SceneLoader.ImportMeshAsync("", data.rootUrl, data.file, scene);
                
                currentMeshes = result.meshes;
                showStatus(`${data.name} Loaded!`);

                // 3. Auto-Center & Frame
                const worldExtends = scene.getWorldExtends(
                    // Filter: Only include the new meshes we just loaded
                    (mesh) => currentMeshes.includes(mesh) && mesh.isVisible
                );
                
                // Safe framing
                const center = worldExtends.min.add(worldExtends.max).scale(0.5);
                const size = worldExtends.max.subtract(worldExtends.min);
                const maxLength = Math.max(size.x, size.y, size.z);

                // Animate camera to new target
                const frameRate = 60;
                const animSpeed = 40;

                // Simple target transition
                BABYLON.Animation.CreateAndStartAnimation("camTarget", camera, "target", frameRate, animSpeed, camera.target, center, 0, new BABYLON.CubicEase());
                
                // Radius transition
                const targetRadius = maxLength * 2.0;
                BABYLON.Animation.CreateAndStartAnimation("camRadius", camera, "radius", frameRate, animSpeed, camera.radius, targetRadius, 0, new BABYLON.CubicEase());

                // Reset Alpha/Beta slightly for a "fresh look" angle
                // camera.alpha = Math.PI / 2;
                // camera.beta = Math.PI / 3;

            } catch (err) {
                console.error(err);
                showStatus(`Failed to load ${data.file}`, true);
            }
        }

        // --- UI BUILDER ---
        const fileList = document.getElementById("fileList");

        library.forEach((item, index) => {
            const div = document.createElement("div");
            div.className = "file-item";
            div.innerHTML = `<div class="icon-box">3D</div> ${item.name}`;
            
            div.onclick = () => {
                // UI: Update active class
                document.querySelectorAll(".file-item").forEach(el => el.classList.remove("active"));
                div.classList.add("active");
                
                // Logic: Load
                loadModel(index);
            };

            fileList.appendChild(div);
        });

        // Load the first model by default
        if (library.length > 0) {
            fileList.children[0].click();
        }

        // --- RENDER LOOP ---
        engine.runRenderLoop(() => {
            if (scene) scene.render();
        });

        window.addEventListener("resize", () => engine.resize());

    </script>
</body>
</html>